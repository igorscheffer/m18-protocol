<!DOCTYPE html>
<html>
<head>
    <!-- Standard Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <title>MILWAUKEE M18</title>

    <link rel="stylesheet" type="text/css" href="/static/fomantic_ui/semantic.min.css">

    <script src="/static/jquery/jquery.min.js"></script>
    <script src="/static/fomantic_ui/semantic.min.js"></script>
    <script src="/static/momentjs/moment.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        
    let battery_type = {
        "37": [2, "2Ah CP (5s1p 18650)"],
        "38": [2, "3Ah XC (5s2p 18650)"],
        "40": [5, "5Ah XC (5s2p 18650)"],
        "165": [5, "5Ah XC (5s2p 18650)"],
        "46": [6, "6Ah XC (5s2p 18650)"],
        "104": [3, "3Ah HO (5s1p 21700)"],
        "106": [4, "6Ah HO (5s2p 21700)"],
        "107": [8, "8Ah HO (5s2p 21700)"],
        "108": [12, "12Ah HO (5s3p 21700)"],
        "383": [8, "8Ah Forge (5s2p 21700 tabless)"],
        "384": [12, "12Ah Forge (5s3p 21700 tabless)"]
    }

    function compareValues(v1, v2){
        if(!["None", false, ""].includes(v1)){
            return v1
        }
        else{
            return v2;
        }

    }

    function createDischargeChart(discharges_time, canvasId = 'dischargeChart') {
        let labels = [];
        let times = [];
        let percentages = [];
        let colors = [];

        let totalTime = Object.values(discharges_time).reduce((sum, block) => sum + block.time, 0);

        function formatTime(sec) {
            let h = Math.floor(sec / 3600);
            let m = Math.floor((sec % 3600) / 60);
            let s = sec % 60;
            return `${h}:${m}:${s}`;
        }

        function getColor(blockName) {
            let start = parseInt(blockName.split('-')[0]);
            let ratio = Math.min(start / 200, 1);
            let r = Math.floor(255 * ratio);
            let g = Math.floor(255 * (1 - ratio));
            return `rgba(${r},${g},0,0.7)`;
        }

        for (let block in discharges_time) {
            labels.push(block);
            times.push(discharges_time[block].time);
            percentages.push(((discharges_time[block].time / totalTime) * 100).toFixed(2));
            colors.push(getColor(block));
        }

        const ctx = document.getElementById(canvasId).getContext('2d');

        if (Chart.getChart(canvasId)) {
            Chart.getChart(canvasId).destroy();
        }

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Time per current range',
                    data: percentages,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        //max: 100,
                        title: { display: true, text: 'Percentage (%)' }
                    },
                    x: {
                        title: { display: true, text: 'Current range (A)' }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let block = context.label;
                                let time = discharges_time[block].time;
                                return `${context.dataset.label}: ${context.parsed.y}% (${formatTime(time)} time)`;
                            }
                        }
                    }
                }
            }
        });
    }

    async function listSerial() {
            try {
                const response = await fetch('/api/ports');
                const data = await response.json();
                const list = document.getElementById('select_serial_port');
                console.log(data.ports);
                if (data.ports && data.ports.length > 0) {
                    data.ports.forEach(port => {
                        const item = document.createElement('div');
                        item.textContent = port.description;
                        item.className = "item";
                        item.dataset.value = port.device;
                        list.appendChild(item);
                    });
                    $(".ui.dropdown").dropdown();
                } else {

                }
            } catch (e) {
                console.log(e);
            }
        }

    $(document).ready(function() {
        let pageLoader = $("#page-loader");
        $('.main.menu').visibility({ type: 'fixed' });
        $('.overlay').visibility({ type: 'fixed', offset: 80 });
        $('.image').visibility({
            type: 'image',
            transition: 'vertical flip in',
            duration: 500
        });

        $('.main.menu  .ui.dropdown').dropdown({
            on: 'hover'
        });

        listSerial();

        function getBatteryData(){
            $.get("/static/battery_data.json").then((d) => {
                const data = d.data;
                const battery_date = data.battery_dates.current_date.value;
                console.log(d);

                let d_battery_info = $("#battery_info");
                let d_battery_chargin = $("#battery_charging");

                d_battery_info.html("");
                d_battery_chargin.html("");

                let l_cell_voltages = [];
                let pack_voltage = 0;
                let cells = data.battery_voltages.cell_voltages_mv.value;
                let voltages = Object.values(cells);

                for (let cell in cells) {
                    if (cells.hasOwnProperty(cell)) {
                        let cell_number = cell.split('_')[1];
                        
                        l_cell_voltages.push(`<div><span style="color: #777; margin-right: 1em;">Cell ${cell_number}</span> ${cells[cell]} mV</div>`);
                        pack_voltage+=cells[cell];
                    }
                }

                let cell_imbalance = voltages.length ? Math.max(...voltages) - Math.min(...voltages) : null;

                let discharges = data.discharges_events.discharge;
                let discharges_time = {};

                for (let discharge in discharges) {
                    if (discharges.hasOwnProperty(discharge)) {
                        let discharge_data = discharges[discharge];
                        let discharge_text = discharge_data.description.trim();

                        let matches = discharge_text.match(/(\d+)-(\d+)/);
                        if (matches) {
                            let start = parseInt(matches[1]);
                            let end = parseInt(matches[2]);

                            let block_start = Math.floor(start / 10) * 10;
                            let block_end = block_start + 10;
                            let block_name = `${block_start}-${block_end}A`;

                            if (!discharges_time[block_name]) {
                                discharges_time[block_name] = { time: 0 };
                            }
                            discharges_time[block_name].time += discharge_data.value;
                        }
                        
                    }
                }

                createDischargeChart(discharges_time);

                let battery_temperature = 
                    (data.battery_temperatures.temperature?.value || 
                    data.battery_temperatures.temperature_forge?.value || 
                    "---") + "ÂºC";

                d_battery_info.append(`
                    <div class="row">
                        <div class="four wide column">
                            <div class="ui header small">Type</div>
                            ${data.battery_info.capacity_serial_number.value.type} [${battery_type[data.battery_info.capacity_serial_number.value.type]}]
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">E-serial</div>
                            ${data.battery_info.capacity_serial_number.value.serial}
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">Manufacture</div>
                            ${moment(data.battery_dates.manufacture_date.value).calendar()}
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">First charge</div>
                            ${moment(compareValues(data.battery_dates.first_charge_date.value, data.battery_dates.first_charge_date_forge.value)).calendar()}
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">Last charge</div>
                            ${moment(compareValues(data.battery_dates.last_charge_date.value, data.battery_dates.last_charge_date_forge.value)).calendar()}
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">Last tool use</div>
                            ${moment(data.battery_dates.last_tool_use_date.value).calendar()}
                        </div>
                    </div>
                    <div class="row">
                        <div class="two wide column">
                            <div class="ui header small">Temperature</div>
                            ${battery_temperature}
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">Cell Imbalance</div>
                            ${cell_imbalance} mV
                        </div>
                        <div class="two wide column">
                            <div class="ui header small">Battery Voltage</div>
                            ${pack_voltage} mV
                        </div>
                        <div class="three wide column">
                            <div class="ui header small" style="margin-bottom: 0;">Battery Voltage</div>
                            ${l_cell_voltages.join("")}
                        </div>
                    </div>
                `);

                d_battery_chargin.append(`
                    <div class="row">
                        <div class="four wide column">
                            <div class="ui header small" style="margin-bottom: 0;">Charge Count</div>
                            <div style="display: inline; margin-right: 1em;"><span style="color: #555;">Redlink</span> (${data.charge_events.redlink_uart_charge_count.value})</div>
                            <div style="display: inline; margin-right: 1em;"><span style="color: #555;">Dump</span> (${data.charge_events.total_charge_count.value - data.charge_events.redlink_uart_charge_count.value})</div>
                            <div style="display: inline; margin-right: 1em;"><span style="color: #555;">Total</span> (${data.charge_events.total_charge_count.value})</div>
                        </div>
                        <div class="four wide column">
                            <div class="ui header small">Total charge time</div>
                            ${data.charge_events.total_charging_time.value}
                        </div>
                        <div class="four wide column">
                            <div class="ui header small">Time idling on charger</div>
                            ${data.charge_events.time_on_charger_full.value}
                        </div>
                        <div class="four wide column">
                            <div class="ui header small">Low-voltage charges</div>
                            ${data.charge_events.started.charge_started_cell_lt_2_5v.value}
                        </div>
                    </div>
                `);

                $(".dimmer").removeClass("active");
            });
        }
    
        getBatteryData();
        
        $(document).on("click", "#generate_file", (e) => {
            let button = $(e.target)
            let serial_port = $("input[name='serial_port']").val();

            if(serial_port == ""){
                alert("select serial port");
                return;
            }

            button.addClass("loading disabled");
            pageLoader.addClass("active");
            
            $.post("/api/read_battery?port="+serial_port, { port: serial_port }, function(response) {
                getBatteryData();
                button.removeClass("loading disabled");
            });
        });
    });
    </script>

    <style type="text/css">

        body {
            background-color: #fff;
        }
        .main.container {
            margin-top: 2em;
        }

        .main.menu {
            margin-top: 4em;
            border-radius: 0;
            border: none;
            box-shadow: none;
            transition:
                box-shadow 0.5s ease,
                padding 0.5s ease
            ;
        }
        .main.menu .item img.logo {
            margin-right: 1.5em;
        }

        .overlay {
            float: left;
            margin: 0em 3em 1em 0em;
        }
        .overlay .menu {
            position: relative;
            left: 0;
            transition: left 0.5s ease;
        }

        .main.menu.fixed {
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.2);
        }
        .overlay.fixed .menu {
            left: 800px;
        }

        .text.container .left.floated.image {
            margin: 2em 2em 2em -4em;
        }
        .text.container .right.floated.image {
            margin: 2em -4em 2em 2em;
        }

        .ui.footer.segment {
            margin: 5em 0em 0em;
            padding: 5em 0em;
        }
    </style>

</head>
<body>
    <div class="ui borderless main menu">
        <div class="ui text container">
            <div class="ui item">
                <div class="ui selection dropdown" style="min-width: 300px">
                    <input type="hidden" name="serial_port">
                    <i class="dropdown icon"></i>
                    <div class="default text">Serial</div>
                    <div id="select_serial_port" class="menu"></div>
                </div>
            </div>
            <a id="generate_file" class="item">LOAD BATTERY DATA</a>
        </div>
    </div>

    <div class="ui container">
        <div id="page-loader" class="ui inverted dimmer">
            <div class="ui text loader">Loading</div>
        </div>
        
        <div class='ui header large'>Battery Info</div>
        <div id="battery_info" class="ui internally grid"></div>

        <div class='ui header large'>Battery Charging</div>
        <div id="battery_charging" class="ui internally grid"></div>
        <canvas id="dischargeChart" width="800" height="400"></canvas>

    </div>
</body>

</html>
